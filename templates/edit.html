<!DOCTYPE html>
<html lang=""en>
<head>
    <meta charset="UTF-8">
    <title>{{basic_information.name}}</title>
    <style>
        /* Apply basic styles for columns */
        .container {
            display: flex;
            justify-content: space-between;
        }
        .column {
            width: 90%; /* Adjust as needed */
            border: 1px solid #ccc;
            padding: 5%;
            box-sizing: border-box;
        }
        .bottom-box {
            background-color: #C4C4C4;
            overflow: hidden;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        svg[id^="mermaid"] {
            min-width: 600px;
            min-height: 200px;
            font-size: 12px;
        }
        .mermaid {
            width: 80%;
        }
    </style>
    <script>    
        var filename = "{{ filename|safe }}";
        var reference_type = "{{ evaluation.reference_type }}";
        var formatter1 = "{{ evaluation.target_formatter }}";
        var model1 = "{{ evaluation.target_LLM }}";
        var model2 = "{{ evaluation.reference_LLM }}";
        var formatter2 = "{{ evaluation.reference_formatter }}";
        var evaluator = "{{ evaluation.evaluator }}";
        var current_formatted_response = "";
        var current_formatted_reference = "";
        var results = Array();
    </script>
</head>

<body>
    <div class="column">
    <b>Benchmark Info</b>
    <p>Benchmark name: {{ basic_information.name }}</p> 
    <p>Benchmark creator: {{ basic_information.creator }}</p>
    <p>Benchmark date: {{ basic_information.date }}</p>
    <p>Benchmark description: {{ basic_information.info }}</p>
    <br></br>
    
    <b>Evaluation Process</b>
    <br></br>

    <div class="mermaid" id="diagram1" >
        flowchart LR
        A1[Case Loader]-->A2
        A1 -- prompt --> B1[target_LLM: {{ evaluation.target_LLM }}]
        B1 -- raw response --> C1[formatter: {{ evaluation.target_formatter }}]
        C1 -- formatted response --> D[evaluator: {{evaluation.evaluator}}]
        A2{refence generated by another LLM?} --Y:prompt-->B2[LLM: {{ evaluation.reference_LLM }}]
        A2{refence generated by another LLM?} --N:None/Given-->D 
        B2 --raw reference-->C2[formatter: {{ evaluation.reference_formatter }}]
        C2 --formatted response--> D
        D --> E[summary]
        linkStyle 5 color:gray,stroke:gray;
    </div>

    <div class="mermaid" id="diagram2">
        flowchart LR
        A1[Case Loader]-->A2
        A1 -- prompt --> B1[target_LLM: {{ evaluation.target_LLM }}]
        B1 -- raw response --> C1[formatter: {{ evaluation.target_formatter }}]
        C1 -- formatted response --> D[evaluator: {{evaluation.evaluator}}]
        A2{refence generated by another LLM?} --Y:prompt-->B2[LLM: {{ evaluation.reference_LLM }}]
        A2{refence generated by another LLM?} --N:{{ evaluation.reference_type }}-->D 
        B2 --raw reference-->C2[formatter: {{ evaluation.reference_formatter }}]
        C2 --formatted response--> D
        D --> E[summary]
        style B2 fill:#e3e3e3
        style C2 fill:#e3e3e3
        linkStyle 4,6,7 color:gray,stroke:gray;
    </div>


    <hr />

    <div id="select_ref">
    Is the reference answer generated by another LLM? (reference_type)?
    <select id="reference_type" onchange="handle_change()">
        <option value="Given">Given</option>
        <option value="None provided">None provided</option>
        <option value="Generated">Generated</option>
    </select>
    <hr />
    </div>

    <div id="select_fmt1">
    Formatter A?
    <select id="formatter1" onchange="handle_change()">
        {% for formatter in formatters%}
            <option value="{{formatter.name}}">{{formatter.name}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <div id="select_model1">
    Test LLM?
    <select id="model1" onchange="handle_change()">
        <option value="random">random</option>
        <option value="GPT-3.5">GPT-3.5</option>
    </select>
    <hr />   
    </div> 

    <div id="select_model2">
    Reference LLM?
    <select id="model2" onchange="handle_change()">
        <option value="random">random</option>
        <option value="GPT-3.5">GPT-3.5</option>
    </select>
    <hr />
    </div>

    <div id="select_fmt2">
    Formatter B?
    <select id="formatter2" onchange="handle_change()">
        {% for formatter in formatters%}
            <option value="{{formatter.name}}">{{formatter.name}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <div id="select_eval">
    Evaluator?
    <select id="evaluator" onchange="handle_change()">
        {% for evaluator in evaluators%}
            <option value="{{evaluator.name}}">{{evaluator.name}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <button onclick="save_eval()">save and refresh</button>
    <button onclick="return_to_benchmark()">return</button> 

    <hr />

    <b>Formatters</b>
    {% for formatter in formatters%}
    <p>Formatter name: {{ formatter.name }}</p>
    <!-- <p>Formatter definition: {{ formatter.definition|safe }}</p> -->
    <p>Formatter definition: </p>
    <textarea style="height: 200px; width: 500px; resize:none" readonly>{{ formatter.definition|safe }}</textarea>
    <p>Formatter info: {{ formatter.info }}</p>
    <br></br>
    {% endfor %}

    <b>Evaluators</b>
    {% for evaluator in evaluators %}
    <p>Evaluator name: {{ evaluator.name }}</p>
    <p>Evaluator definition: </p>
    <textarea style="height: 200px; width: 500px; resize:none" readonly>{{ evaluator.definition|safe }}</textarea>
    <p>Evaluator info: {{ evaluator.info }}</p>
    <br></br>
    {% endfor %}

    <hr />

    </div>
</body>

{% for formatter in formatters %}
<!-- <script id="formatter_{{formatter.name}}">
    {{ formatter.definition|safe}}
</script> -->
<script>
    {{ formatter.definition|safe }}
</script>
{% endfor %}

{% for evaluator in evaluators %}
<script>
    {{ evaluator.definition|safe }}
</script>
{% endfor %}

<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: true,
        flowchart: {
          useMaxWidth: true,
          straightEdges: true
        }
      });
</script>

<script>

</script>

<script>
// 读取初始配置
function initChoiceById(id, value) {
    var dropdown = document.getElementById(id);
    console.log(value);
    console.log('option[value="'.concat(value).concat('"]'));
    var choice = dropdown.querySelector('option[value="'.concat(value).concat('"]'));
    console.log(choice);
    choice.setAttribute('selected', 'selected');
}

window.onload = function() {

    if ('{{ evaluation.reference_type }}'=='Generated') {
        document.getElementById('diagram2').style.display = 'none';
    }
    else {
        document.getElementById('diagram1').style.display = 'none';
    } 

    console.log('init log');
    
    initChoiceById("reference_type", "{{ evaluation.reference_type }}");
    initChoiceById("formatter1", "{{ evaluation.target_formatter }}");
    initChoiceById("model1", "{{ evaluation.target_LLM }}");
    initChoiceById("model2", "{{ evaluation.reference_LLM }}");
    initChoiceById("formatter2", "{{ evaluation.reference_formatter }}");
    initChoiceById("evaluator", "{{ evaluation.evaluator }}");

    handle_change();
}

// 保存测试配置，刷新
function save_eval() {
    reference_type = document.getElementById("reference_type").value;
    formatter1 = document.getElementById("formatter1").value;
    model1 = document.getElementById("model1").value;
    model2 = document.getElementById("model2").value;
    formatter2 = document.getElementById("formatter2").value;
    evaluator = document.getElementById("evaluator").value;

    fetch('/save_eval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({'filename': filename, 
                                'evaluation': {
                                    'reference_type': reference_type, 
                                    'target_formatter': formatter1,
                                    'target_LLM': model1,
                                    'reference_LLM': model2,
                                    'reference_formatter': formatter2,
                                    'evaluator': evaluator}
            })
        });
    location.reload();
}

function return_to_benchmark() {
    window.location.href = window.location.href;
}

// 实时更新流程图配置部分，无关的配置不予显示
function handle_change() {
    reference_type = document.getElementById("reference_type").value;

    if (reference_type != "Generated") {
        document.getElementById('select_model2').style.display = 'none';
        document.getElementById('select_fmt2').style.display = 'none';
    }
    else {
        document.getElementById('select_model2').style.display = 'block';
        document.getElementById('select_fmt2').style.display = 'block';
    }
}

</script>
