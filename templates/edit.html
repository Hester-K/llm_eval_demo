<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{basic_information.name}}</title>
    <style>
        .container {
            display: flex;
            justify-content: center;
        }
        .box1 {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            margin-bottom: 60px;
            border: 2px solid #000; 
            border-radius: 15px; 
            background-color: transparent; 
        }
        .column {
            width: 90%; 
            padding-left: 5%;
            padding-top: 2%;
            box-sizing: border-box;
        }
        svg[id^="mermaid"] {
            min-width: 95%;
            min-height: 200px;
            font-size: 12px;
        }
        .mermaid {
            width: 80%;
        }
    </style>
    <link href="{{ url_for('static', filename='prism.css')}}" rel="stylesheet">
    <style>  
        pre code.language-javascript {  
            font-size: 12px; 
        }  
    </style>
    <script src="{{ url_for('static', filename='prism.js') }}" async></script>
    <script type="text/javascript" src="{{ url_for('static', filename='canvas.js') }}"></script>
    <script>    
        var filename = "{{ filename|safe }}";
        var reference_type = "{{ evaluation.reference_type }}";
        var formatter1 = "{{ evaluation.target_formatter }}";
        var model1 = "{{ evaluation.target_LLM }}";
        var model2 = "{{ evaluation.reference_LLM }}";
        var formatter2 = "{{ evaluation.reference_formatter }}";
        var evaluator = "{{ evaluation.evaluator }}";
        var current_formatted_response = "";
        var current_formatted_reference = "";
    </script>
</head>

<body>

    <div class="column">
        <div class="box1">
        <b>Benchmark Info</b>
        <div class="content">
            <p>Benchmark name: {{ basic_information.name }}</p> 
            <p>Benchmark creator: {{ basic_information.creator }}</p>
            <p>Benchmark date: {{ basic_information.date }}</p>
            <p>Benchmark description: {{ basic_information.info }}</p>
        </div>
        </div>
    
    <div class="box1">
    <b>Evaluation Process</b>
    <br></br>


    <div class="container">
    <canvas id="myCanvas" width="720" height="400"></canvas>  
    <script>
    function renderCanvas() {
        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawRect(ctx, 5, 100, 100, 50, "Case Loader", "");
        drawRect(ctx, 150, 5, 120, 50, "target_LLM:", model1);
        drawRect(ctx, 120, 200, 120, 50, "reference_type:", reference_type);
        drawRect(ctx, 200, 300, 120, 50, "reference_LLM:", model2, reference_type!='Generated');
        drawRect(ctx, 450, 300, 150, 50, "reference_formatter:", formatter2, reference_type!='Generated');
        drawRect(ctx, 400, 5, 150, 50, "formatter:", formatter1);
        drawRect(ctx, 600, 100, 100, 50, "evaluator:", evaluator);
        drawArrow(ctx, 50, 100, 150, 25, "right", "prompt");
        drawArrow(ctx, 50, 150, 120, 225, "right", "");
        drawArrow(ctx, 270, 25, 400, 25, "right", "raw response");
        drawArrow(ctx, 550, 25, 650, 100, "down", "formatted response");
        drawArrow(ctx, 180, 200, 650, 180, "right", "expected answer", reference_type!='Given', arrow=false);
        drawArrow(ctx, 240, 225, 650, 225, "right", "none", reference_type!='None provided', arrow=false);
        drawArrow(ctx, 180, 250, 200, 325, "right", "prompt", reference_type!='Generated');
        drawArrow(ctx, 320, 325, 450, 325, "right", "raw reference", reference_type!='Generated');
        drawArrow(ctx, 600, 325, 650, 150, "up", "formatted reference", reference_type!='Generated', reference_type=='Generated');
        if (reference_type != 'Generated') {
            var y = reference_type=='Given' ? 180 : 225;
            drawArrow(ctx, 650, y, 650, 150, 'up', '');
        }
    }
    </script>
    </div>

    <div id="select_ref">
    Is the reference answer generated by another LLM? (reference_type)?
    <select id="reference_type" onchange="handle_change()">
        <option value="Given">Given</option>
        <option value="None provided">None provided</option>
        <option value="Generated">Generated</option>
    </select>
    <hr />
    </div>

    <div id="select_fmt1">
    Formatter A?
    <select id="formatter1" onchange="handle_change()">
        {% for formatter in formatters%}
            <option value="{{formatter.name}}">{{formatter.name}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <div id="select_model1">
    Test LLM?
    <select id="model1" onchange="handle_change()">
        {% for llm in llms %}
            <option value="{{llm}}">{{llm}}</option>
        {% endfor %}
    </select>
    <hr />   
    </div> 

    <div id="select_model2">
    Reference LLM?
    <select id="model2" onchange="handle_change()">
        {% for llm in llms %}
            <option value="{{llm}}">{{llm}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <div id="select_fmt2">
    Formatter B?
    <select id="formatter2" onchange="handle_change()">
        {% for formatter in formatters%}
            <option value="{{formatter.name}}">{{formatter.name}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <div id="select_eval">
    Evaluator?
    <select id="evaluator" onchange="handle_change()">
        {% for evaluator in evaluators%}
            <option value="{{evaluator.name}}">{{evaluator.name}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <button onclick="save_eval()">save</button>
    <button onclick="return_to_benchmark()">return</button>

    </div>

    <div class="box1">
    <b>Formatters</b>
    <br><br>
    {% for formatter in formatters%}
    <hr />
    <p>Formatter name: {{ formatter.name }}</p>
    <p>Formatter definition: </p>
    <div style="width: 98%; overflow:visible; display: inline-block;">
        <pre><code class="language-javascript">{{ formatter.definition|safe }}</code></pre>
    </div>
    <p>Formatter info: {{ formatter.info }}</p>
    {% endfor %}
    </div>

    <div class="box1">
    <b>Evaluators</b>
    <br><br>
    {% for evaluator in evaluators %}
    <hr />
    <p>Evaluator name: {{ evaluator.name }}</p>
    <p>Evaluator definition: </p>
    <div style="width: 98%; overflow:visible; display: inline-block;">
        <pre><code class="language-javascript">{{ evaluator.definition|safe }}</code></pre>
    </div>
    <p>Evaluator info: {{ evaluator.info }}</p>
    {% endfor %}

    </div>

    <div class="box1">
        <b>Results</b>
        <br><br>
        {% for result in results%}
        <p>{{ result.result }}</p>
        {% endfor %}
    </div>

    </div>
</body>

{% for formatter in formatters %}
<script>
    {{ formatter.definition|safe }}
</script>
{% endfor %}

{% for evaluator in evaluators %}
<script>
    {{ evaluator.definition|safe }}
</script>
{% endfor %}

<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: true,
        flowchart: {
          useMaxWidth: true,
          straightEdges: true
        }
      });
</script>

<script>
function initChoiceById(id, value) {
    var dropdown = document.getElementById(id);
    var choice = dropdown.querySelector('option[value="'.concat(value).concat('"]'));
    choice.setAttribute('selected', 'selected');
}

document.addEventListener('DOMContentLoaded', function() {

    renderCanvas();
    
    initChoiceById("reference_type", "{{ evaluation.reference_type }}");
    initChoiceById("formatter1", "{{ evaluation.target_formatter }}");
    initChoiceById("model1", "{{ evaluation.target_LLM }}");
    initChoiceById("model2", "{{ evaluation.reference_LLM }}");
    initChoiceById("formatter2", "{{ evaluation.reference_formatter }}");
    initChoiceById("evaluator", "{{ evaluation.evaluator }}");

    handle_change();
});

function return_to_benchmark() {
    fetch('/benchmark/{{ filename }}/return_to_benchmark', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => {
            window.location.href = '/benchmark/{{ filename }}';
        });
}

function save_eval() {
    reference_type = document.getElementById("reference_type").value;
    formatter1 = document.getElementById("formatter1").value;
    model1 = document.getElementById("model1").value;
    model2 = document.getElementById("model2").value;
    formatter2 = document.getElementById("formatter2").value;
    evaluator = document.getElementById("evaluator").value;

    fetch('/save_eval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({'filename': filename, 
                                'evaluation': {
                                    'reference_type': reference_type, 
                                    'target_formatter': formatter1,
                                    'target_LLM': model1,
                                    'reference_LLM': model2,
                                    'reference_formatter': formatter2,
                                    'evaluator': evaluator}
            })
        });
    location.reload();
}

function handle_change() {
    reference_type = document.getElementById("reference_type").value;
    formatter1 = document.getElementById("formatter1").value;
    model1 = document.getElementById("model1").value;
    model2 = document.getElementById("model2").value;
    formatter2 = document.getElementById("formatter2").value;
    evaluator = document.getElementById("evaluator").value;

    if (reference_type != "Generated") {
        document.getElementById('select_model2').style.display = 'none';
        document.getElementById('select_fmt2').style.display = 'none';
    }
    else {
        document.getElementById('select_model2').style.display = 'block';
        document.getElementById('select_fmt2').style.display = 'block';
    }
    renderCanvas();
}

</script>