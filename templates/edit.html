<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{basic_information.name}}</title>
    <style>
        .container {
            display: flex;
            justify-content: space-between;
        }
        .box1 {
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            margin-bottom: 60px;
            border: 2px solid #000; 
            border-radius: 15px; 
            background-color: transparent; 
        }
        .column {
            width: 90%; 
            padding-left: 5%;
            padding-top: 2%;
            box-sizing: border-box;
        }
        svg[id^="mermaid"] {
            min-width: 95%;
            min-height: 200px;
            font-size: 12px;
        }
        .mermaid {
            width: 80%;
        }
    </style>
    <link href="{{ url_for('static', filename='prism.css')}}" rel="stylesheet">
    <style>  
        pre code.language-javascript {  
            font-size: 12px; 
        }  
    </style>
    <script src="{{ url_for('static', filename='prism.js') }}" async></script>
    <script>    
        var filename = "{{ filename|safe }}";
        var reference_type = "{{ evaluation.reference_type }}";
        var formatter1 = "{{ evaluation.target_formatter }}";
        var model1 = "{{ evaluation.target_LLM }}";
        var model2 = "{{ evaluation.reference_LLM }}";
        var formatter2 = "{{ evaluation.reference_formatter }}";
        var evaluator = "{{ evaluation.evaluator }}";
        var current_formatted_response = "";
        var current_formatted_reference = "";
    </script>
</head>

<body>

    <div class="column">
        <div class="box1">
        <b>Benchmark Info</b>
        <div class="content">
            <p>Benchmark name: {{ basic_information.name }}</p> 
            <p>Benchmark creator: {{ basic_information.creator }}</p>
            <p>Benchmark date: {{ basic_information.date }}</p>
            <p>Benchmark description: {{ basic_information.info }}</p>
        </div>
        </div>
    
    <div class="box1">
    <b>Evaluation Process</b>
    <br></br>

    <div class="mermaid" id="diagram1" >
        flowchart LR
        A1[Case Loader]-->A2
        A1 -- prompt --> B1[target_LLM: {{ evaluation.target_LLM }}]
        B1 -- raw response --> C1[formatter: {{ evaluation.target_formatter }}]
        C1 -- formatted response --> D[evaluator: {{evaluation.evaluator}}]
        A2{refence generated by another LLM?} --Y:prompt-->B2[LLM: {{ evaluation.reference_LLM }}]
        A2{refence generated by another LLM?} --N:None/Given-->D 
        B2 --raw reference-->C2[formatter: {{ evaluation.reference_formatter }}]
        C2 --formatted reference--> D
        D --> E[summary]
        linkStyle 5 color:gray,stroke:gray,stroke-dasharray:10,5;
    </div>

    <div class="mermaid" id="diagram2">
        flowchart LR
        A1[Case Loader]-->A2
        A1 -- prompt --> B1[target_LLM: {{ evaluation.target_LLM }}]
        B1 -- raw response --> C1[formatter: {{ evaluation.target_formatter }}]
        C1 -- formatted response --> D[evaluator: {{evaluation.evaluator}}]
        A2{refence generated by another LLM?} --Y:prompt-->B2[LLM: {{ evaluation.reference_LLM }}]
        A2{refence generated by another LLM?} --N:{{ evaluation.reference_type }}-->D 
        B2 --raw reference-->C2[formatter: {{ evaluation.reference_formatter }}]
        C2 --formatted reference--> D
        D --> E[summary]
        style B2 fill:#e3e3e3
        style C2 fill:#e3e3e3
        linkStyle 4,6,7 color:gray,stroke:gray,stroke-dasharray:10,5;
    </div>
    <hr />

    <div id="select_ref">
    Is the reference answer generated by another LLM? (reference_type)?
    <select id="reference_type" onchange="handle_change()">
        <option value="Given">Given</option>
        <option value="None provided">None provided</option>
        <option value="Generated">Generated</option>
    </select>
    <hr />
    </div>

    <div id="select_fmt1">
    Formatter A?
    <select id="formatter1" onchange="handle_change()">
        {% for formatter in formatters%}
            <option value="{{formatter.name}}">{{formatter.name}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <div id="select_model1">
    Test LLM?
    <select id="model1" onchange="handle_change()">
        {% for llm in llms %}
            <option value="{{llm}}">{{llm}}</option>
        {% endfor %}
    </select>
    <hr />   
    </div> 

    <div id="select_model2">
    Reference LLM?
    <select id="model2" onchange="handle_change()">
        {% for llm in llms %}
            <option value="{{llm}}">{{llm}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <div id="select_fmt2">
    Formatter B?
    <select id="formatter2" onchange="handle_change()">
        {% for formatter in formatters%}
            <option value="{{formatter.name}}">{{formatter.name}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <div id="select_eval">
    Evaluator?
    <select id="evaluator" onchange="handle_change()">
        {% for evaluator in evaluators%}
            <option value="{{evaluator.name}}">{{evaluator.name}}</option>
        {% endfor %}
    </select>
    <hr />
    </div>

    <button onclick="save_eval()">save and refresh</button>
    <button onclick="return_to_benchmark()">return</button>

    </div>

    <div class="box1">
    <b>Formatters</b>
    <br><br>
    {% for formatter in formatters%}
    <hr />
    <p>Formatter name: {{ formatter.name }}</p>
    <p>Formatter definition: </p>
    <div style="width: 98%; overflow:visible; display: inline-block;">
        <pre><code class="language-javascript">{{ formatter.definition|safe }}</code></pre>
    </div>
    <p>Formatter info: {{ formatter.info }}</p>
    {% endfor %}
    </div>

    <div class="box1">
    <b>Evaluators</b>
    <br><br>
    {% for evaluator in evaluators %}
    <hr />
    <p>Evaluator name: {{ evaluator.name }}</p>
    <p>Evaluator definition: </p>
    <div style="width: 98%; overflow:visible; display: inline-block;">
        <pre><code class="language-javascript">{{ evaluator.definition|safe }}</code></pre>
    </div>
    <p>Evaluator info: {{ evaluator.info }}</p>
    {% endfor %}

    </div>

    <div class="box1">
        <b>Results</b>
        <br><br>
        {% for result in results%}
        <p>{{ result.result }}</p>
        {% endfor %}
    </div>

    </div>
</body>

{% for formatter in formatters %}
<script>
    {{ formatter.definition|safe }}
</script>
{% endfor %}

{% for evaluator in evaluators %}
<script>
    {{ evaluator.definition|safe }}
</script>
{% endfor %}

<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: true,
        flowchart: {
          useMaxWidth: true,
          straightEdges: true
        }
      });
</script>

<script>
function initChoiceById(id, value) {
    var dropdown = document.getElementById(id);
    console.log(value);
    console.log('option[value="'.concat(value).concat('"]'));
    var choice = dropdown.querySelector('option[value="'.concat(value).concat('"]'));
    console.log(choice);
    choice.setAttribute('selected', 'selected');
}

document.addEventListener('DOMContentLoaded', function() {

    if ('{{ evaluation.reference_type }}'=='Generated') {
        document.getElementById('diagram2').style.display = 'none';
    }
    else {
        document.getElementById('diagram1').style.display = 'none';
    } 

    console.log('init log');
    
    initChoiceById("reference_type", "{{ evaluation.reference_type }}");
    initChoiceById("formatter1", "{{ evaluation.target_formatter }}");
    initChoiceById("model1", "{{ evaluation.target_LLM }}");
    initChoiceById("model2", "{{ evaluation.reference_LLM }}");
    initChoiceById("formatter2", "{{ evaluation.reference_formatter }}");
    initChoiceById("evaluator", "{{ evaluation.evaluator }}");

    handle_change();
});

function return_to_benchmark() {
    fetch('/benchmark/{{ filename }}/return_to_benchmark', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => {
            window.location.href = '/benchmark/{{ filename }}';
        });
}

function save_eval() {
    reference_type = document.getElementById("reference_type").value;
    formatter1 = document.getElementById("formatter1").value;
    model1 = document.getElementById("model1").value;
    model2 = document.getElementById("model2").value;
    formatter2 = document.getElementById("formatter2").value;
    evaluator = document.getElementById("evaluator").value;

    fetch('/save_eval', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({'filename': filename, 
                                'evaluation': {
                                    'reference_type': reference_type, 
                                    'target_formatter': formatter1,
                                    'target_LLM': model1,
                                    'reference_LLM': model2,
                                    'reference_formatter': formatter2,
                                    'evaluator': evaluator}
            })
        });
    location.reload();
}

function handle_change() {
    reference_type = document.getElementById("reference_type").value;

    if (reference_type != "Generated") {
        document.getElementById('select_model2').style.display = 'none';
        document.getElementById('select_fmt2').style.display = 'none';
    }
    else {
        document.getElementById('select_model2').style.display = 'block';
        document.getElementById('select_fmt2').style.display = 'block';
    }
}

</script>